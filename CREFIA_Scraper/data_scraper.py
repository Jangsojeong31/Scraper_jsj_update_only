"""
데이터 추출 유틸리티
텍스트와 파일명에서 제정일, 개정일, 소관부서를 추출하는 함수
"""
import re
from typing import Tuple


def extract_data_from_text(text: str) -> Tuple[str, str, str]:
    """
    텍스트에서 제정일, 개정일, 소관부서 추출
    
    Args:
        text: 추출할 텍스트 (초반 100자)
        
    Returns:
        (제정일, 최근_개정일, 소관부서) 튜플
    """
    if not text:
        return "", "", ""
    
    enactment_date = ""
    revision_date = ""
    department = ""
    
    # 제정일 패턴 (명시적 패턴 우선, 일반 패턴 후순위)
    enactment_patterns = [
        # 명시적 패턴 (제정일: 형식) - 우선순위 높음
        r"제\s*정\s*일\s*[:：]\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",              # 제정일: 2024.3.29.
        r"제\s*정\s*일\s*[:：]\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",     # 제정일: 2024년 3월 29일
        r"제\s*정\s*일\s*[:：]?\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?", # 제정일: 2024.3.29
        r"제\s*정\s*일\s*[:：]?\s*(\d{4})-(\d{1,2})-(\d{1,2})",                        # 제정일: 2024-3-29
        
        # 일반 패턴 (제정: 또는 제정 형식)
        r"제\s*정\s*[:：]\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",                    # 제정: 2024.3.29. (공백 포함)
        r"제\s*정\s*[:：]\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",           # 제정: 2024년 3월 29일
        r"제\s*정\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",                            # 제정 2024.3.29. (공백 포함)
        r"제\s*정\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",                    # 제정 2024년 3월 29일
        r"제\s*정\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?",              # 제정 2024.3.29
        r"제\s*정\s*(\d{4})-(\d{1,2})-(\d{1,2})",                                      # 제정 2024-3-29
        
        # 추가 패턴
        r"제\s*정\s*(\d{4})/(\d{1,2})/(\d{1,2})",                                      # 제정 2024/3/29
        r"제\s*정\s*일\s*(\d{4})/(\d{1,2})/(\d{1,2})",                                 # 제정일 2024/3/29
        r"\(제\s*정\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?\)",                       # (제정 2024.3.29.)
    ]

    # 개정일 패턴 (명시적 패턴 우선, 일반 패턴 후순위)
    revision_patterns = [
        # 최종/최근 개정일 패턴 - 우선순위 최고
        r"최종\s*개\s*정\s*일\s*[:：]?\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",      # 최종 개정일: 2024.3.29.
        r"최종\s*개\s*정\s*일\s*[:：]?\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일", # 최종 개정일: 2024년 3월 29일
        r"최종\s*개\s*정\s*일\s*[:：]?\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?", # 최종 개정일: 2024.3.29
        r"최근\s*개\s*정\s*일\s*[:：]?\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",        # 최근 개정일: 2024.3.29.
        r"최근\s*개\s*정\s*일\s*[:：]?\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일", # 최근 개정일: 2024년 3월 29일
        r"최근\s*개\s*정\s*일\s*[:：]?\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?", # 최근 개정일: 2024.3.29
        
        # 개정일: 형식
        r"개\s*정\s*일\s*[:：]\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",               # 개정일: 2024.3.29.
        r"개\s*정\s*일\s*[:：]\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",       # 개정일: 2024년 3월 29일
        r"개\s*정\s*일\s*[:：]?\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?",  # 개정일: 2024.3.29
        r"개\s*정\s*일\s*[:：]?\s*(\d{4})-(\d{1,2})-(\d{1,2})",                         # 개정일: 2024-3-29
        
        # 일반 패턴 (개정: 또는 개정 형식)
        r"개\s*정\s*[:：]\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",                     # 개정: 2024.3.29. (공백 포함)
        r"개\s*정\s*[:：]\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",            # 개정: 2024년 3월 29일
        r"개\s*정\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",                             # 개정 2024.3.29. (공백 포함)
        r"개\s*정\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",                     # 개정 2024년 3월 29일
        r"개\s*정\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?",               # 개정 2024.3.29
        r"개\s*정\s*(\d{4})-(\d{1,2})-(\d{1,2})",                                       # 개정 2024-3-29
        
        # 추가 패턴
        r"개\s*정\s*(\d{4})/(\d{1,2})/(\d{1,2})",                                       # 개정 2024/3/29
        r"개\s*정\s*일\s*(\d{4})/(\d{1,2})/(\d{1,2})",                                  # 개정일 2024/3/29
        r"\(개\s*정\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?\)",                        # (개정 2024.3.29.)
        r"\(최종\s*개\s*정\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?\)",                 # (최종 개정 2024.3.29.)
    ]

    # 소관부서 패턴 (다양한 형식 지원)
    department_patterns = [
        # 명시적 패턴 (소관부서: 형식) - 우선순위 높음
        r"소\s*관\s*부\s*서\s*[:：]\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정|최종|최근)",  # 소관부서: XXX
        r"소\s*관\s*부\s*서\s*[:：]?\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정)",          # 소관부서 XXX (콜론 없음)
        r"소\s*관\s*[:：]\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정|최종|최근)",           # 소관: XXX
        r"소\s*관\s*[:：]?\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정)",                    # 소관 XXX (콜론 없음)
        
        # 담당부서 패턴
        r"담\s*당\s*부\s*서\s*[:：]\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정|최종|최근)",  # 담당부서: XXX
        r"담\s*당\s*부\s*서\s*[:：]?\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정)",          # 담당부서 XXX (콜론 없음)
        r"담\s*당\s*[:：]\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정|최종|최근)",            # 담당: XXX
        r"담\s*당\s*[:：]?\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정)",                     # 담당 XXX (콜론 없음)
        
        # 운영부서 패턴
        r"운\s*영\s*부\s*서\s*[:：]\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정|최종|최근)",  # 운영부서: XXX
        r"운\s*영\s*부\s*서\s*[:：]?\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정)",           # 운영부서 XXX (콜론 없음)
        
        # 주관부서 패턴
        r"주\s*관\s*부\s*서\s*[:：]\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정|최종|최근)",  # 주관부서: XXX
        r"주\s*관\s*부\s*서\s*[:：]?\s*([가-힣\s]+?)(?:\n|$|\.|,|;|제정|개정)",           # 주관부서 XXX (콜론 없음)
        
        # 개정일 뒤에 결재 정보와 함께 나오는 패턴 (예: "개정 2024.3.29. 국장결재 국제총괄팀-793")
        r"개\s*정\s*\d{4}\.?\s*\d{1,2}\.?\s*\d{1,2}\.?\s*[가-힣]*결재\s+([가-힣]+팀)\s*-",  # 공백 포함
        r"개\s*정\s*\d{4}\.?\s*\d{1,2}\.?\s*\d{1,2}\.?\s*[가-힣]*결재\s+([가-힣]+팀)-",   # 공백 없음
        r"개\s*정\s*\d{4}\.?\s*\d{1,2}\.?\s*\d{1,2}\.?\s*[가-힣]*결재\s+([가-힣]+부)\s*-", # 부서명 (팀 대신 부)
        r"개\s*정\s*\d{4}\.?\s*\d{1,2}\.?\s*\d{1,2}\.?\s*[가-힣]*결재\s+([가-힣]+부)-",   # 부서명 (팀 대신 부, 공백 없음)
        r"개\s*정\s*\d{4}\.?\s*\d{1,2}\.?\s*\d{1,2}\.?\s*[가-힣]*결재\s+([가-힣]+과)\s*-", # 과명
        r"개\s*정\s*\d{4}\.?\s*\d{1,2}\.?\s*\d{1,2}\.?\s*[가-힣]*결재\s+([가-힣]+과)-",   # 과명 (공백 없음)
        r"개\s*정\s*\d{4}\.?\s*\d{1,2}\.?\s*\d{1,2}\.?\s*[가-힣]*결재\s+([가-힣]+실)\s*-", # 실명
        r"개\s*정\s*\d{4}\.?\s*\d{1,2}\.?\s*\d{1,2}\.?\s*[가-힣]*결재\s+([가-힣]+실)-",   # 실명 (공백 없음)
        
        # 일반적인 부서명 패턴 (앞뒤 문맥 고려)
        r"(?:소관|담당|운영|주관)\s*(?:부서)?\s*[:：]?\s*([가-힣]+(?:팀|부|과|실|국|원|처|청|원|소))",  # 일반 부서명
    ]

    def normalize_date(year: str, month: str, day: str) -> str:
        """날짜를 YYYY.MM.DD 형식으로 정규화"""
        try:
            return f"{year}.{int(month):02d}.{int(day):02d}."
        except Exception:
            return f"{year}.{month}.{day}."
    
    def clean_department(dept: str) -> str:
        """소관부서 텍스트 정리 (공백 제거, 불필요한 문자 제거)"""
        if not dept:
            return ""
        # 앞뒤 공백 제거
        dept = dept.strip()
        # 연속된 공백을 하나로
        dept = re.sub(r'\s+', ' ', dept)
        # 전화번호나 기타 숫자 제거 (예: "-793", "02-1234-5678")
        dept = re.sub(r'\s*-\s*\d+.*$', '', dept)
        dept = re.sub(r'\s*\(\d+\)', '', dept)
        return dept.strip()
    
    # 제정일 추출
    for pattern in enactment_patterns:
        match = re.search(pattern, text)
        if match:
            groups = match.groups()
            if len(groups) >= 3:
                enactment_date = normalize_date(groups[0], groups[1], groups[2])
                break
    
    # 개정일 추출 (모든 매치를 찾아서 마지막 것 사용)
    all_revision_matches = []
    for pattern in revision_patterns:
        matches = list(re.finditer(pattern, text))
        for match in matches:
            groups = match.groups()
            if len(groups) >= 3:
                all_revision_matches.append((
                    match.start(),
                    normalize_date(groups[0], groups[1], groups[2])
                ))
    
    if all_revision_matches:
        # 마지막 개정일 선택 (텍스트에서 가장 뒤에 나온 것)
        all_revision_matches.sort(key=lambda x: x[0])
        revision_date = all_revision_matches[-1][1]
    
    # 소관부서 추출 (모든 매치를 찾아서 첫 번째 것 사용)
    all_department_matches = []
    for pattern in department_patterns:
        matches = list(re.finditer(pattern, text))
        for match in matches:
            groups = match.groups()
            if len(groups) >= 1:
                dept = clean_department(groups[0])
                if dept:
                    all_department_matches.append((
                        match.start(),
                        dept
                    ))
    
    if all_department_matches:
        # 첫 번째 소관부서 선택 (텍스트에서 가장 앞에 나온 것)
        all_department_matches.sort(key=lambda x: x[0])
        department = all_department_matches[0][1]
    
    return enactment_date, revision_date, department


def extract_dates_from_filename(filename: str) -> Tuple[str, str]:
    """
    파일명에서 제정일과 개정일 추출
    
    Args:
        filename: 파일명 (예: "고령_금융소비자보호_가이드라인(2024.08.01._개정)")
        
    Returns:
        (제정일, 최근_개정일) 튜플
    """
    if not filename:
        return "", ""
    
    enactment_date = ""
    revision_date = ""
    
    # 파일명 패턴 (괄호 안의 날짜 형식)
    # 예: (2024.08.01._개정), (2018.3.7 개정(1차)), (21.5.18.개정)
    
    def normalize_date(year: str, month: str, day: str) -> str:
        """날짜를 YYYY.MM.DD 형식으로 정규화"""
        try:
            # 2자리 연도를 4자리로 변환 (50 이상이면 1900년대, 미만이면 2000년대)
            if len(year) == 2:
                year_int = int(year)
                if year_int >= 50:
                    year = f"19{year}"
                else:
                    year = f"20{year}"
            return f"{year}.{int(month):02d}.{int(day):02d}."
        except Exception:
            return f"{year}.{month}.{day}."
    
    # 제정일 패턴 (파일명용)
    enactment_filename_patterns = [
        # (YYYY.MM.DD. 제정) 형식
        r"\((\d{4})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*제\s*정",  # (2024.08.01. 제정)
        r"\((\d{4})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*제\s*정\s*일",  # (2024.08.01. 제정일)
        r"\((\d{4})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*제\s*정\s*\)",  # (2024.08.01. 제정)
        # (YY.M.D. 제정) 형식 (2자리 연도)
        r"\((\d{2})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*제\s*정",  # (24.8.1. 제정)
        r"\((\d{2})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*제\s*정\s*일",  # (24.8.1. 제정일)
        r"\((\d{2})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*제\s*정\s*\)",  # (24.8.1. 제정)
        # 제정일: 형식 (콜론 포함)
        r"제\s*정\s*일\s*[:：]\s*(\d{4})\.(\d{1,2})\.(\d{1,2})",  # 제정일: 2024.08.01
        r"제\s*정\s*[:：]\s*(\d{4})\.(\d{1,2})\.(\d{1,2})",  # 제정: 2024.08.01
    ]
    
    # 개정일 패턴 (파일명용) - 우선순위 높은 것부터
    revision_filename_patterns = [
        # (YYYY.MM.DD. 개정) 형식 - 다양한 변형
        r"\((\d{4})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*개\s*정",  # (2024.08.01. 개정)
        r"\((\d{4})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*개\s*정\s*일",  # (2024.08.01. 개정일)
        r"\((\d{4})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*개\s*정\s*\)",  # (2024.08.01. 개정)
        r"\((\d{4})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*개\s*정\s*\([^)]*\)",  # (2024.08.01. 개정(1차))
        r"\((\d{4})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*개\s*정\s*[^)]*\)",  # (2024.08.01. 개정(추가정보))
        
        # (YY.M.D. 개정) 형식 (2자리 연도)
        r"\((\d{2})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*개\s*정",  # (24.8.1. 개정)
        r"\((\d{2})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*개\s*정\s*일",  # (24.8.1. 개정일)
        r"\((\d{2})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*개\s*정\s*\)",  # (24.8.1. 개정)
        r"\((\d{2})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*개\s*정\s*\([^)]*\)",  # (24.8.1. 개정(1차))
        r"\((\d{2})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*개\s*정\s*[^)]*\)",  # (24.8.1. 개정(추가정보))
        
        # 최종/최근 개정일 패턴
        r"\((\d{4})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*최\s*종\s*개\s*정",  # (2024.08.01. 최종개정)
        r"\((\d{4})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*최\s*근\s*개\s*정",  # (2024.08.01. 최근개정)
        r"\((\d{2})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*최\s*종\s*개\s*정",  # (24.8.1. 최종개정)
        r"\((\d{2})\.(\d{1,2})\.(\d{1,2})\.?\s*[_\s]*최\s*근\s*개\s*정",  # (24.8.1. 최근개정)
        
        # 개정일: 형식 (콜론 포함)
        r"개\s*정\s*일\s*[:：]\s*(\d{4})\.(\d{1,2})\.(\d{1,2})",  # 개정일: 2024.08.01
        r"개\s*정\s*[:：]\s*(\d{4})\.(\d{1,2})\.(\d{1,2})",  # 개정: 2024.08.01
        r"최\s*종\s*개\s*정\s*일\s*[:：]\s*(\d{4})\.(\d{1,2})\.(\d{1,2})",  # 최종개정일: 2024.08.01
        r"최\s*근\s*개\s*정\s*일\s*[:：]\s*(\d{4})\.(\d{1,2})\.(\d{1,2})",  # 최근개정일: 2024.08.01
        
        # 하이픈 구분자 형식
        r"\((\d{4})-(\d{1,2})-(\d{1,2})\s*[_\s]*개\s*정",  # (2024-08-01 개정)
        r"\((\d{2})-(\d{1,2})-(\d{1,2})\s*[_\s]*개\s*정",  # (24-8-1 개정)
        
        # 슬래시 구분자 형식
        r"\((\d{4})/(\d{1,2})/(\d{1,2})\s*[_\s]*개\s*정",  # (2024/08/01 개정)
        r"\((\d{2})/(\d{1,2})/(\d{1,2})\s*[_\s]*개\s*정",  # (24/8/1 개정)
    ]
    
    # 제정일 추출
    for pattern in enactment_filename_patterns:
        match = re.search(pattern, filename)
        if match:
            groups = match.groups()
            if len(groups) >= 3:
                enactment_date = normalize_date(groups[0], groups[1], groups[2])
                break
    
    # 개정일 추출 (모든 매치를 찾아서 마지막 것 사용)
    all_revision_matches = []
    for pattern in revision_filename_patterns:
        matches = list(re.finditer(pattern, filename))
        for match in matches:
            groups = match.groups()
            if len(groups) >= 3:
                all_revision_matches.append((
                    match.start(),
                    normalize_date(groups[0], groups[1], groups[2])
                ))
    
    if all_revision_matches:
        # 마지막 개정일 선택 (파일명에서 가장 뒤에 나온 것)
        all_revision_matches.sort(key=lambda x: x[0])
        revision_date = all_revision_matches[-1][1]
    
    return enactment_date, revision_date

