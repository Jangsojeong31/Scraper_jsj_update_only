"""
날짜 추출 유틸리티
텍스트에서 제정일과 개정일을 추출하는 함수
"""
import re
from typing import Tuple


def extract_dates_from_text(text: str) -> Tuple[str, str]:
    """
    텍스트에서 제정일과 개정일 추출
    
    Args:
        text: 추출할 텍스트 (초반 100자)
        
    Returns:
        (제정일, 최근_개정일) 튜플
    """
    if not text:
        return "", ""
    
    enactment_date = ""
    revision_date = ""
    
    # 제정일 패턴 (명시적 패턴 우선, 일반 패턴 후순위)
    enactment_patterns = [
        # 명시적 패턴 (제정일: 형식) - 우선순위 높음
        r"제\s*정\s*일\s*[:：]\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",              # 제정일: 2024.3.29.
        r"제\s*정\s*일\s*[:：]\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",     # 제정일: 2024년 3월 29일
        r"제\s*정\s*일\s*[:：]?\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?", # 제정일: 2024.3.29
        r"제\s*정\s*일\s*[:：]?\s*(\d{4})-(\d{1,2})-(\d{1,2})",                        # 제정일: 2024-3-29
        
        # 일반 패턴 (제정: 또는 제정 형식)
        r"제\s*정\s*[:：]\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",                    # 제정: 2024.3.29. (공백 포함)
        r"제\s*정\s*[:：]\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",           # 제정: 2024년 3월 29일
        r"제\s*정\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",                            # 제정 2024.3.29. (공백 포함)
        r"제\s*정\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",                    # 제정 2024년 3월 29일
        r"제\s*정\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?",              # 제정 2024.3.29
        r"제\s*정\s*(\d{4})-(\d{1,2})-(\d{1,2})",                                      # 제정 2024-3-29
        
        # 추가 패턴
        r"제\s*정\s*(\d{4})/(\d{1,2})/(\d{1,2})",                                      # 제정 2024/3/29
        r"제\s*정\s*일\s*(\d{4})/(\d{1,2})/(\d{1,2})",                                 # 제정일 2024/3/29
        r"\(제\s*정\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?\)",                       # (제정 2024.3.29.)
    ]

    # 개정일 패턴 (명시적 패턴 우선, 일반 패턴 후순위)
    revision_patterns = [
        # 최종/최근 개정일 패턴 - 우선순위 최고
        r"최종\s*개\s*정\s*일\s*[:：]?\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",      # 최종 개정일: 2024.3.29.
        r"최종\s*개\s*정\s*일\s*[:：]?\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일", # 최종 개정일: 2024년 3월 29일
        r"최종\s*개\s*정\s*일\s*[:：]?\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?", # 최종 개정일: 2024.3.29
        r"최근\s*개\s*정\s*일\s*[:：]?\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",        # 최근 개정일: 2024.3.29.
        r"최근\s*개\s*정\s*일\s*[:：]?\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일", # 최근 개정일: 2024년 3월 29일
        r"최근\s*개\s*정\s*일\s*[:：]?\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?", # 최근 개정일: 2024.3.29
        
        # 개정일: 형식
        r"개\s*정\s*일\s*[:：]\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",               # 개정일: 2024.3.29.
        r"개\s*정\s*일\s*[:：]\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",       # 개정일: 2024년 3월 29일
        r"개\s*정\s*일\s*[:：]?\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?",  # 개정일: 2024.3.29
        r"개\s*정\s*일\s*[:：]?\s*(\d{4})-(\d{1,2})-(\d{1,2})",                         # 개정일: 2024-3-29
        
        # 일반 패턴 (개정: 또는 개정 형식)
        r"개\s*정\s*[:：]\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",                     # 개정: 2024.3.29. (공백 포함)
        r"개\s*정\s*[:：]\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",            # 개정: 2024년 3월 29일
        r"개\s*정\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?",                             # 개정 2024.3.29. (공백 포함)
        r"개\s*정\s*(\d{4})\s*년\s*(\d{1,2})\s*월\s*(\d{1,2})\s*일",                     # 개정 2024년 3월 29일
        r"개\s*정\s*(\d{4})[.\-년]\s*(\d{1,2})[.\-월]\s*(\d{1,2})[일.]?",               # 개정 2024.3.29
        r"개\s*정\s*(\d{4})-(\d{1,2})-(\d{1,2})",                                       # 개정 2024-3-29
        
        # 추가 패턴
        r"개\s*정\s*(\d{4})/(\d{1,2})/(\d{1,2})",                                       # 개정 2024/3/29
        r"개\s*정\s*일\s*(\d{4})/(\d{1,2})/(\d{1,2})",                                  # 개정일 2024/3/29
        r"\(개\s*정\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?\)",                        # (개정 2024.3.29.)
        r"\(최종\s*개\s*정\s*(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.?\)",                 # (최종 개정 2024.3.29.)
    ]

    def normalize_date(year: str, month: str, day: str) -> str:
        """날짜를 YYYY.MM.DD 형식으로 정규화"""
        try:
            return f"{year}.{int(month):02d}.{int(day):02d}."
        except Exception:
            return f"{year}.{month}.{day}."
    
    # 제정일 추출
    for pattern in enactment_patterns:
        match = re.search(pattern, text)
        if match:
            groups = match.groups()
            if len(groups) >= 3:
                enactment_date = normalize_date(groups[0], groups[1], groups[2])
                break
    
    # 개정일 추출 (모든 매치를 찾아서 마지막 것 사용)
    all_revision_matches = []
    for pattern in revision_patterns:
        matches = list(re.finditer(pattern, text))
        for match in matches:
            groups = match.groups()
            if len(groups) >= 3:
                all_revision_matches.append((
                    match.start(),
                    normalize_date(groups[0], groups[1], groups[2])
                ))
    
    if all_revision_matches:
        # 마지막 개정일 선택 (텍스트에서 가장 뒤에 나온 것)
        all_revision_matches.sort(key=lambda x: x[0])
        revision_date = all_revision_matches[-1][1]
    
    return enactment_date, revision_date

